<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raw File Sharing System</title>
    <style>
        body {
            font-family: sans-serif;
            line-height: 1.6;
            background-color: #f4f4f4;
            color: #333;
            max-width: 800px;
            margin: 2rem auto;
            padding: 1rem;
        }
        .container {
            background: #fff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        h1, h2 {
            text-align: center;
        }
        form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-width: 400px;
            margin: 0 auto;
        }
        input[type="email"], input[type="password"], input[type="file"], button {
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .file-list {
            margin-top: 2rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .file-item {
            padding: 0.5rem;
            background: #e9ecef;
            border-radius: 4px;
            word-wrap: break-word;
        }
        #auth-container {
            text-align: center;
        }
        #auth-container button {
            margin-top: 1rem;
        }
        #logout-btn {
            background-color: #dc3545;
            margin-bottom: 1rem;
        }
        .hidden {
            display: none;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="container">
        <h1>Raw File Sharing System</h1>

        <div id="logged-in-section" class="hidden">
            <h2>Welcome!</h2>
            <p>You are logged in. You can upload new files.</p>
            <button id="logout-btn">Logout</button>
            
            <h3>Upload a Raw File</h3>
            <form id="upload-form">
                <input type="file" id="file-input" required>
                <button type="submit">Upload File</button>
            </form>
            <p id="upload-status"></p>
        </div>

        <div id="auth-container">
            <h3>Sign Up or Log In to Share</h3>
            <form id="auth-form">
                <input type="email" id="email-input" placeholder="Email" required>
                <input type="password" id="password-input" placeholder="Password" required>
                <button type="submit" id="auth-btn">Sign Up / Log In</button>
            </form>
            <p id="auth-status"></p>
        </div>

        <div id="file-viewer">
            <h2>Public Files</h2>
            <div class="file-list" id="file-list">
                <p>Loading files...</p>
            </div>
        </div>
    </div>

    <script>
        // Supabase Client Setup
        const SUPABASE_URL = 'https://ebpgktodtwqnnpzagqvp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVicGdrdG9kdHdxbm5wemFncXZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3OTc5ODgsImV4cCI6MjA2OTM3Mzk4OH0.G54yMXsd8El-QOTbxdc1g8LWsPihfVLC-XgcRKizy1w';  
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // DOM Elements
        const authContainer = document.getElementById('auth-container');
        const loggedInSection = document.getElementById('logged-in-section');
        const authForm = document.getElementById('auth-form');
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');
        const authStatus = document.getElementById('auth-status');
        const logoutBtn = document.getElementById('logout-btn');
        const uploadForm = document.getElementById('upload-form');
        const fileInput = document.getElementById('file-input');
        const uploadStatus = document.getElementById('upload-status');
        const fileListContainer = document.getElementById('file-list');

        // Function to update UI based on user session
        const updateUI = (session) => {
            if (session) {
                authContainer.classList.add('hidden');
                loggedInSection.classList.remove('hidden');
            } else {
                authContainer.classList.remove('hidden');
                loggedInSection.classList.add('hidden');
            }
        };

        // Handle initial session and listen for auth changes
        const { data: { session } } = await supabase.auth.getSession();
        updateUI(session);

        supabase.auth.onAuthStateChange((event, session) => {
            updateUI(session);
        });

        // Handle Sign Up / Log In
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = emailInput.value;
            const password = passwordInput.value;
            authStatus.textContent = 'Processing...';

            const { data, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password,
            });

            if (error) {
                if (error.message.includes('No user with that email')) {
                     // If user doesn't exist, try to sign them up
                     const { data: signUpData, error: signUpError } = await supabase.auth.signUp({
                        email: email,
                        password: password,
                     });

                     if (signUpError) {
                        authStatus.textContent = `Sign Up Error: ${signUpError.message}`;
                     } else {
                        authStatus.textContent = 'Sign up successful! Check your email for a confirmation link.';
                     }
                } else {
                    authStatus.textContent = `Error: ${error.message}`;
                }
            } else {
                authStatus.textContent = 'Logged in successfully!';
                emailInput.value = '';
                passwordInput.value = '';
            }
        });

        // Handle Logout
        logoutBtn.addEventListener('click', async () => {
            const { error } = await supabase.auth.signOut();
            if (error) {
                console.error('Logout error:', error);
            }
        });

        // Handle File Upload
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            uploadStatus.textContent = 'Uploading...';

            const file = fileInput.files[0];
            if (!file) {
                uploadStatus.textContent = 'Please select a file to upload.';
                return;
            }
            
            const user = (await supabase.auth.getSession()).data.session.user;
            const filePath = `${user.id}/${Date.now()}_${file.name}`;

            const { data, error } = await supabase.storage
                .from('raw_files')
                .upload(filePath, file, {
                    cacheControl: '3600',
                    upsert: false
                });

            if (error) {
                uploadStatus.textContent = `Upload failed: ${error.message}`;
                console.error('Upload error:', error);
            } else {
                uploadStatus.textContent = 'File uploaded successfully!';
                
                // Store file metadata in the database
                const { error: dbError } = await supabase
                    .from('files')
                    .insert([
                        {
                            file_path: filePath,
                            owner_id: user.id
                        }
                    ]);

                if (dbError) {
                    console.error('Database insert error:', dbError);
                }
                
                // Refresh the file list
                fetchFiles();
            }
        });

        // Function to fetch and display files
        const fetchFiles = async () => {
            fileListContainer.innerHTML = '';
            fileListContainer.textContent = 'Fetching files...';

            // Fetch public file information from the 'files' table
            const { data, error } = await supabase
                .from('files')
                .select('file_path');

            if (error) {
                console.error('Error fetching files:', error);
                fileListContainer.textContent = 'Error fetching files.';
                return;
            }

            if (data.length === 0) {
                fileListContainer.textContent = 'No files have been shared yet.';
                return;
            }

            // Generate links for each file
            data.forEach(file => {
                const { file_path } = file;
                const fileURL = `${SUPABASE_URL}/storage/v1/object/public/raw_files/${file_path}`;
                const filename = file_path.split('/').pop();

                const link = document.createElement('a');
                link.href = fileURL;
                link.target = '_blank';
                link.textContent = filename;
                link.className = 'file-item';

                fileListContainer.appendChild(link);
            });
        };

        // Fetch files when the page loads
        fetchFiles();

    </script>
</body>
</html>
